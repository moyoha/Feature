<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zip Upload</title>
  <script src="https://cdn.bootcdn.net/ajax/libs/jszip/3.5.0/jszip.min.js"></script>
</head>
<body>
  <input type="file" id="uploadFile" accept="image/*" webkitdirectory>
  <button onclick="uploadFile()">Upload</button>
</body>
<script>
  const uploadFileEle = document.querySelector("#uploadFile");

async function uploadFile() {
    if (!uploadFileEle.files.length) {
      alert("请选择上传文件")
      return
    };

    console.log(uploadFileEle.files);

    const webkitRelativePath = uploadFileEle.files[0].webkitRelativePath;
    const zipFileName = webkitRelativePath.split("/")[0] + ".zip";
    const zipFile = await generateZipFile(zipFileName, uploadFileEle.files);
    upload({ url: "/upload/single", file: zipFile, fileName: zipFileName });
}

// 生成压缩文件 https://stuk.github.io/jszip/
function generateZipFile(zipName, files, options = { type: "blob", compression: "DEFLATE" }) {
  return new Promise((resolve, reject) => {
    const zip = new JSZip();
    for (let i = 0; i < files.length; i++) {
      zip.file(files[i].webkitRelativePath, files[i]);
    }
    zip.generateAsync(options).then(function (blob) {
      zipName = zipName || Date.now() + ".zip";
      const zipFile = new File([blob], zipName, { type: "application/zip" });
      resolve(zipFile);
    });
  });
}

function upload({ url, file, fileName, fieldName = "file" }) {
    let formData = new FormData();
    formData.append(fieldName, file, fileName);

    fetch(`http://localhost:3000${url}`, { method: "POST", body: formData })
      .then(res => res.json())
      .then(res => {
          console.log(res);
      })
    }
</script>
</html>