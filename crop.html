<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>图片裁剪</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    /* 四个角的样式 start */
    .horn {
      width: 8px;
      height: 8px;
      background-color: #fff;
      position: absolute;
      border: 1px solid #dbdbdb;
      border-radius: 50%;
    }
    .leftTop {
      cursor: nw-resize;
      left: -4px;
      top: -4px;
    }

    .rightTop {
      cursor: ne-resize;
      right: -4px;
      top: -4px;
    }

    .leftBottom {
      cursor: sw-resize;
      bottom: -4px;
      left: -4px;
    }

    .rightBottom {
      cursor: se-resize;
      right: -4px;
      bottom: -4px;
    }
    /* 四个角的样式 end */

    /* 左右两侧样式 start */
    .vertical {
      width: 6px;
      height: 12px;
      position: absolute;
      background-color: #fff;
      border: 1px solid #dbdbdb;
      border-radius: 3px;
      cursor: col-resize;
    }
    .left {
      top: calc(50% - 6px);
      left: -3px;
    }
    .right {
      top: calc(50% - 6px);
      right: -3px;
    }
    /* 左右两侧样式 end */
    /* 上下两侧样式 start */
    .horizontal {
      width: 12px;
      height: 6px;
      position: absolute;
      background-color: #fff;
      border: 1px solid #dbdbdb;
      border-radius: 3px;
      cursor: row-resize;
    }
    .top {
      top: -3px;
      left: calc(50% - 6px);
    }
    
    .bottom {
      left: calc(50% - 6px);
      bottom: -3px;
    }
    /* 上下两侧样式 end */
    
  </style>
  <style>
    .cut-container {
      position: relative;
      width: fit-content;
      height: fit-content;
      user-select: none;
      font-size: 0;
    }
    #select-box {
      width: 100px;
      height: 100px;
      border: 1px solid #5864f6;
      position: absolute;
      display: none;
      cursor: move;
      z-index: 100;
    }
    img {
      -webkit-user-drag: none;
    }
  </style>
</head>
<body>
  <div class="cut-container">
    <img src="./assets/imgs/2.jpeg" crossorigin="anonymous">
    <div id="select-box"></div>
  </div>
  <button type="button" id="crop-btn">裁剪</button>
</body>
<script>

const img = document.querySelector('img');
const selectBox = document.querySelector('#select-box');
const cropBtn = document.querySelector('#crop-btn');

let dropIns = null
// 图片加载完成
img.addEventListener('load', () => {
  selectBox.style.display = 'block';
  // 把区域选择框放到 img 上
  selectBox.style.top = img.offsetTop + 'px';
  selectBox.style.left = img.offsetLeft + 'px';
  dropIns = new ZoomAndDrag(selectBox, img)
});


// 图片裁剪按钮点击
cropBtn.addEventListener('click', async () => {
  const {blob, url} = await dropIns.crop()
  console.log(blob, url)
  const img = document.createElement('img')
  img.src = url
  document.body.append(img)
});


/** 注意事项 
 * 1. 目标元素若存在外边距，那么目标元素在移动时会超出父元素(定位同理)
 * 2. 父元素若存在内边距，那么目标元素在移动时也会超出父元素
 */

class ZoomAndDrag {
  width = 0 // 目标元素宽度
  height = 0 // 目标元素高度
  pWidth = 0 // 目标父元素宽度
  pHeight = 0 // 目标父元素高度
  newWidth = 0 // 目标元素缩放后的宽度
  newHeight = 0 // 目标元素缩放后的高度
  startX = 0 // 鼠标起始位置的 X 坐标
  startY = 0 // 鼠标起始位置的 Y 坐标
  tx = 0 // 目标元素在 X 轴上的初始偏移
  ty = 0 // 目标元素在 Y 轴上的初始偏移
  newTx = 0 // 目标元素缩放、移动后在 X 轴上的偏移
  newTy = 0 // 目标元素缩放、移动后在 Y 轴上的偏移
  // 配置项 minWidth：缩放的最小宽度，minHeight：缩放最小高度，squre: 缩放后是否保持宽高比
  options = { minWidth: 50, minHeight: 50, square: false }
  target = null // 目标元素
  img = null // 图片元素
  top = null // 上边框
  bottom = null // 下边框
  left = null // 左边框
  right = null // 右边框
  leftTop = null // 左上角
  leftBottom = null // 左下角
  rightTop = null // 右上角
  rightBottom = null // 右下角
  constructor(target, img, options = {}) {
    this.target = target
    this.img = img
    this.options = { ...options, ...this.options }
    this.init()
  }

  init(){
    this.target.style.position = "absolute"
    if(!this.target.style.transform) {
      this.target.style.transform = "translate(0px,0px)"
    }
    // 初始化时需获取元素自身信息，避免直接进行裁剪操作时，数据为空
    this.getSelfInfo()
    this.getBoundary()
    this.drag()
    this.addHorn()
    this.addBorder()
    this.zoom(this.left, "left")
    this.zoom(this.right,"right")
    this.zoom(this.top,"top")
    this.zoom(this.bottom,"bottom")
    this.zoom(this.leftTop,"leftTop")
    this.zoom(this.leftBottom,"leftBottom")
    this.zoom(this.rightTop,"rightTop")
    this.zoom(this.rightBottom,"rightBottom")
  }

  // 获取目标元素的初始宽高、偏移以及鼠标的起始位置信息
  getInfo(e) {
    this.getSelfInfo()

    this.startX = e.clientX
    this.startY = e.clientY
  }
  getSelfInfo() {
    this.width = this.target.offsetWidth
    this.height = this.target.offsetHeight
    this.newWidth = this.width
    if (this.options.square) {
      this.newHeight = this.newWidth
    } else {
      this.newHeight = this.height
    }

    let translateStr = this.target.style.transform
    const reg = /\d+/g
    let translateArr = translateStr.match(reg)
    this.tx = +translateArr[0]
    this.newTx = this.tx
    this.ty = +translateArr[1]
    this.newTy = this.ty
  }

  // 获取父元素的宽高
  getBoundary() {
    this.pWidth = this.target.parentNode.clientWidth
    this.pHeight = this.target.parentNode.clientHeight
    console.log(this.pWidth, this.pHeight)
  }

  // 拖动实现
  drag() {
    this.target.addEventListener("mousedown", (e) => {
      this.getInfo(e)
      document.onmousemove = (e) => {
        if(this.options.limit){
          this.newTx = Math.max(0, Math.min(this.tx + e.clientX - this.startX, this.pWidth - this.width))
          this.newTy = Math.max(0, Math.min(this.ty + e.clientY - this.startY, this.pHeight - this.height))
        }else{
          this.newTx = this.tx + e.clientX - this.startX
          this.newTy = this.ty + e.clientY - this.startY
        }
        this.target.style.transform = `translate(${this.newTx}px, ${this.newTy}px)`
      }
      document.onmouseup = () => {
        document.onmousemove = null
      }
    })
  }

  // 缩放实现
  zoom(el, direction) {
    el.addEventListener("mousedown", (e) => {
      e.stopPropagation()
      this.getInfo(e)
      document.onmousemove = (e) => {
        switch(direction) {
          case "left": this.leftInfo(e); break;
          case "right": this.rightInfo(e); break;
          case "top": this.topInfo(e); break;
          case "bottom": this.bottomInfo(e); break;
          case "leftTop": this.leftTopInfo(e); break;
          case "leftBottom": this.leftBottomInfo(e); break;
          case "rightTop": this.rightTopInfo(e); break;
          case "rightBottom": this.rightBottomInfo(e); break;
        }
        this.target.style.width = `${this.newWidth}px`
        this.target.style.height = `${this.newHeight}px`
        this.target.style.transform = `translate(${this.newTx}px, ${this.newTy}px)`
      }
      document.onmouseup = () => {
        document.onmousemove = null
      }
    })
  }

  // 裁剪
  crop() {
    return new Promise((resolve, reject) => {
      const canvas = document.createElement("canvas")
      canvas.width = this.newWidth
      canvas.height = this.newHeight
      const ctx = canvas.getContext("2d")
      console.log(this.newTx, this.newTy, this.newWidth, this.newHeight, 0, 0, this.newWidth, this.newHeight)
      ctx.drawImage(this.img, this.newTx, this.newTy, this.newWidth, this.newHeight, 0, 0, this.newWidth, this.newHeight)
      canvas.toBlob(blob => {
        if (blob === null) {
          reject("图片裁剪失败")
        } else {
          const url = URL.createObjectURL(blob)
          resolve({blob, url})
        }
      });
    })
  }
  // 添加四个角
  addHorn() {
    this.leftTop = document.createElement("div")
    this.rightTop = document.createElement("div")
    this.leftBottom = document.createElement("div")
    this.rightBottom = document.createElement("div")
    this.leftTop.className = "horn leftTop"
    this.rightTop.className = "horn rightTop"
    this.leftBottom.className = "horn leftBottom"
    this.rightBottom.className = "horn rightBottom"
    this.target.append(this.leftTop)
    this.target.append(this.rightTop)
    this.target.append(this.leftBottom)
    this.target.append(this.rightBottom)
  }

  // 添加四条边
  addBorder() {
    this.left = document.createElement("div")
    this.right = document.createElement("div")
    this.top = document.createElement("div")
    this.bottom = document.createElement("div")
    this.left.className = "vertical left"
    this.right.className = "vertical right"
    this.top.className = "horizontal top"
    this.bottom.className = "horizontal bottom"
    this.target.append(this.left)
    this.target.append(this.right)
    this.target.append(this.top)
    this.target.append(this.bottom)
  }

  // 向左进行缩放操作
  leftInfo(e) {
    this.newWidth = this.width - (e.clientX - this.startX)
    this.newTx = this.tx + (e.clientX - this.startX)

    this.newWidth = Math.max(this.options.minWidth, Math.min(this.newWidth, this.width + this.tx))
    this.newTx = Math.max(0, Math.min(this.newTx, this.width + this.tx - this.options.minWidth))
  }

  // 向右进行缩放操作
  rightInfo(e) {
    this.newWidth = this.width + (e.clientX - this.startX)

    this.newWidth = Math.max(this.options.minWidth, Math.min(this.newWidth, this.pWidth - this.tx))
  }

  // 向上进行缩放操作
  topInfo(e) {
    this.newHeight = this.height - (e.clientY - this.startY)
    this.newTy = this.ty + (e.clientY - this.startY)

    this.newHeight = Math.max(this.options.minHeight, Math.min(this.newHeight, this.height + this.ty))
    this.newTy = Math.max(0, Math.min(this.newTy, this.height + this.ty - this.options.minHeight))
  }

  // 向下进行缩放操作
  bottomInfo(e) {
    this.newHeight = this.height + (e.clientY - this.startY)

    this.newHeight = Math.max(this.options.minHeight, Math.min(this.newHeight, this.pHeight - this.ty))
  }

  // 左上角进行缩放操作
  leftTopInfo(e) {
    this.leftInfo(e)
    this.topInfo(e)
  }

  // 左下角进行缩放操作
  leftBottomInfo(e) {
    this.leftInfo(e)
    this.bottomInfo(e)
  }

  // 右上角进行缩放操作
  rightTopInfo(e) {
    this.rightInfo(e)
    this.topInfo(e)
  }

  // 右下角进行缩放操作
  rightBottomInfo(e) {
    this.rightInfo(e)
    this.bottomInfo(e)
  }
}

</script>
</html>